name: Dependency Updates

on:
  schedule:
    # Check for updates weekly on Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:  # Allow manual triggering

jobs:
  check-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm install
    
    - name: Check for outdated dependencies
      id: outdated
      run: |
        echo "ðŸ” Checking for outdated dependencies..."
        npm outdated --json > outdated.json || echo "{}" > outdated.json
        cat outdated.json
        
    - name: Create report if updates available
      run: |
        echo "ðŸ“‹ Dependency Update Report" > dependency-report.md
        echo "===========================" >> dependency-report.md
        echo "" >> dependency-report.md
        
        # Check if there are outdated dependencies
        if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
          echo "## ðŸ“¦ Updates Available" >> dependency-report.md
          echo "" >> dependency-report.md
          npm outdated --parseable | while read line; do
            if [ ! -z "$line" ]; then
              echo "- $line" >> dependency-report.md
            fi
          done
          echo "" >> dependency-report.md
          echo "### ðŸ’¡ Recommended Actions:" >> dependency-report.md
          echo "1. Run \`npm update\` to update minor versions" >> dependency-report.md
          echo "2. Review major version updates manually" >> dependency-report.md
          echo "3. Run tests after updates" >> dependency-report.md
        else
          echo "## âœ… All Dependencies Up to Date" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "No dependency updates available at this time." >> dependency-report.md
        fi
        
        cat dependency-report.md

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm install
    
    - name: Run security audit
      run: |
        echo "ðŸ”’ Running security audit..."
        npm audit --audit-level moderate || echo "Security audit completed"
    
    - name: Generate security report
      run: |
        echo "ðŸ›¡ï¸ Security Audit Report" > security-report.md
        echo "======================" >> security-report.md
        echo "" >> security-report.md
        echo "Scan completed: $(date)" >> security-report.md
        echo "" >> security-report.md
        echo "Run \`npm audit fix\` to automatically fix vulnerabilities." >> security-report.md

  upload-reports:
    name: Upload Reports
    runs-on: ubuntu-latest
    needs: [check-updates, security-audit]
    
    steps:
    - name: Download and combine reports
      run: |
        echo "# ðŸ“Š Dependency and Security Report" > combined-report.md
        echo "Generated: $(date)" >> combined-report.md
        echo "" >> combined-report.md
        
        if [ -f dependency-report.md ]; then
          cat dependency-report.md >> combined-report.md
        fi
        
        echo "" >> combined-report.md
        echo "---" >> combined-report.md
        echo "" >> combined-report.md
        
        if [ -f security-report.md ]; then
          cat security-report.md >> combined-report.md
        fi
        
        echo "" >> combined-report.md
        echo "---" >> combined-report.md
        echo "*This report was automatically generated by GitHub Actions*" >> combined-report.md
    
    - name: Upload combined report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-security-report
        path: |
          combined-report.md
          dependency-report.md
          security-report.md
        retention-days: 30