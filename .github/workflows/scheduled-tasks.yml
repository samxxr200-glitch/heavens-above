name: Scheduled Maintenance Tasks

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: npm install
    
    - name: Verify application health
      run: |
        echo "🔍 Running health checks..."
        # Check if main files exist and are valid
        node -c run.js && echo "✅ run.js syntax valid"
        node -c src/iridium.js && echo "✅ iridium.js syntax valid" || echo "⚠️ iridium.js has issues"
        node -c src/satellite.js && echo "✅ satellite.js syntax valid" || echo "⚠️ satellite.js has issues"
        
        # Check package.json validity
        npm audit --audit-level moderate || echo "⚠️ Security audit completed with warnings"
        
        echo "🏥 Health check completed"

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Check for outdated dependencies
      run: |
        echo "📦 Checking for outdated dependencies..."
        npm outdated || echo "All dependencies are up to date"
    
    - name: Check dependency vulnerabilities
      run: |
        echo "🔒 Checking for security vulnerabilities..."
        npm audit --audit-level high || echo "Security check completed"

  cleanup-reports:
    name: Cleanup Reports
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate cleanup report
      run: |
        echo "🧹 Cleanup Report - $(date)"
        echo "=============================="
        echo "📊 Repository Size:"
        du -sh . || echo "Size check not available"
        echo ""
        echo "📁 Large files:"
        find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" | head -10 || echo "No large files found"
        echo ""
        echo "✅ Cleanup check completed"

  notify-summary:
    name: Notification Summary
    runs-on: ubuntu-latest
    needs: [health-check, dependency-check, cleanup-reports]
    
    steps:
    - name: Create summary issue
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];
          const summary = `
          # Scheduled Maintenance Report - ${date}
          
          ## Summary
          - **Health Check**: ${context.job === 'health-check' ? 'Completed' : 'Unknown'}
          - **Dependency Check**: ${context.job === 'dependency-check' ? 'Completed' : 'Unknown'}
          - **Cleanup Report**: ${context.job === 'cleanup-reports' ? 'Completed' : 'Unknown'}
          
          ## Next Actions
          - Review dependency updates if available
          - Check security audit results
          - Verify application health status
          
          _This report was automatically generated by GitHub Actions._
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Scheduled Maintenance Report - ${date}`,
            body: summary,
            labels: ['automated', 'maintenance']
          });